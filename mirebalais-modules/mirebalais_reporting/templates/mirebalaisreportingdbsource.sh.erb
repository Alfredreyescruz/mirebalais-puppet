#!/bin/sh
#
# Script to source the DB dump created by the production server on the reporting server
#

USER='<%= @openmrs_db_user %>'
PASSWORD='<%= @openmrs_db_password %>'
DB='<%= @openmrs_db %>'

DECRYPT_PASSWORD='<%= @backup_db_password %>'

DIR='/home/backups'
FILENAME='mirebalais_nightly_reporting_dump.sql.7z'
FILENAME_DECOMPRESSED='mirebalais_nightly_reporting_dump.sql'

# Stop tomcat
service tomcat7 stop

# Unzip and unencrypt database
7za e -p${DECRYPT_PASSWORD} -soy ${DIR}/${FILENAME} 1> ${DIR}/${FILENAME_DECOMPRESSED} 2>/dev/null

# Source the database
mysql -u ${USER} -p${PASSWORD} ${DB} < ${DIR}/${FILENAME_DECOMPRESSED} 2>/dev/null

# Clean remove db file
rm ${DIR}/${FILENAME_DECOMPRESSED}

# Restart tomcat
service tomcat7 start

# Run the pentaho pipeline
docker run --net="host" --rm -v /home/reporting:/home/reporting -v /home/reporting/.kettle/pih-kettle.properties:/opt/pentaho/.kettle/pih-kettle.properties pih:pdi /opt/pentaho/data-integration/kitchen.sh -file="/home/reporting/pih-pentaho/jobs/load-from-openmrs-and-star-schema.kjb" >> /home/reporting/logs/pentaho.log