#!/bin/bash

set -x

backupDir="/home/reporting/percona/backups"
compressedDir="/home/reporting/percona/backups/openmrs.tar"
perconaLogs="/home/reporting/percona/logs"
#perconaRestoreDir="/home/reporting/percona/backups"
perconaRestoreDir="/home/reporting/percona/backups/openmrs"
dataDir="/var/lib/mysql"
reportingTables="/home/reporting/percona/dumps/reporing_tables.sql"
mysqlDb="/home/reporting/percona/dumps/mysql.sql"

uncompressDb () {
                        tar -xvf ${compressedDir} -C ${backupDir} &>> ${perconaLogs}/`date +%y%m%d%H%M%S`_uncompress.log
}

perconaPrepare () {
                        innobackupex --apply-log ${perconaRestoreDir} &>> ${perconaLogs}/`date +%y%m%d%H%M%S`_perconapreparebackup.log
}

perconaRestore () {
                # We should be stopping mysql first
                rm -rf ${dataDir}/*
                innobackupex --copy-back ${perconaRestoreDir} &>> ${perconaLogs}/`date +%y%m%d%H%M%S`_perconarestore.log
                chown -R mysql: ${dataDir}
}

restoreReportingTablesAndDb () {
                        sudo mysqld_safe --skip-grant-tables & mysql -uroot -e "CREATE DATABASE mysql;"
                        mysql -uroot -D mysql -e "SOURCE $mysqlDb;"
                        mysql -uroot -D openmrs -e "SOURCE ${reportingTables};"

}

deletePerconaDb () {
                rm -rf ${backupDir}/*
}

reboot () {
                sudo reboot
}

uncompressDb
perconaPrepare
perconaRestore
sleep 180
restoreReportingTablesAndDb
deletePerconaDb
reboot
