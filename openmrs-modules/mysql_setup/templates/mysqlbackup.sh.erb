#!/bin/sh
#
# Backup Script
#

USER='<%= @backup_user %>'
PASS='<%= @backup_password %>'
DIR=/home/<%= @tomcat %>/backups

REMOTE_DB='<%= @remote_db_user %>@<%= @remote_db_server %>:<%= @remote_backup_dir %>'

if [ -n "$1" ]
then
  MODIFIER=release_$1
else
  MODIFIER=`date +%Y%m%d`
fi

FILENAME=openmrs_backup_${MODIFIER}.sql.bz2

# create the needed directories
mkdir -p ${DIR}/current
mkdir -p ${DIR}/sequences


mysqldump -u${USER} -p${PASS} --opt --flush-logs --single-transaction --master-data=2 openmrs | bzcat -zc > ${DIR}/sequences/${FILENAME}

# link the current to the latest dump
rm -f ${DIR}/current/openmrs_current_backup.sql.bz2
ln -s ${DIR}/sequences/${FILENAME} ${DIR}/current/openmrs_current_backup.sql.bz2

#scp ${DIR}/current/openmrs_current_backup.sql.bz2 ${REMOTE_DB}/${FILENAME}